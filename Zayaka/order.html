<!DOCTYPE html>
<html>

<head>
    <script>
        var menujson;
        function getnumberofdaysinamonth() {
            var date = new Date();
            var currentMonth = date.getMonth() + 1;
            var datestuff;
            if (currentMonth == 2) {
                datestuff = 28;
            }

            if (currentMonth == 4 || currentMonth == 6 || currentMonth == 9 || currentMonth == 11) {
                datestuff = 30;
            }
            if (currentMonth == 1 || currentMonth == 3 || currentMonth == 5 || currentMonth == 7 || currentMonth == 8 || currentMonth == 10 || currentMonth == 12) {
                datestuff = 31;
            }
            return datestuff;
        }
        function choosestartpoint() {
            var date = new Date();
            var getDate = date.getDate() % 7;
            var getDay = date.getDay();
            var startday = (getDay - getDate)
            return startday + 1;
        }

        function makeCalender() {
            var date = new Date();
            var currentDate = date.getDate();
            var startday;
            var days = getnumberofdaysinamonth();
            var calender = '<table border=1>';
            calender += '<tr>';
            calender += '<th>Sunday</th>';
            calender += '<th>Monday</th>';
            calender += '<th>Tuesday</th>';
            calender += '<th>Wednesday</th>';
            calender += '<th>Thursday</th>';
            calender += '<th>Friday</th>';
            calender += '<th>Saturday</th>';
            calender += '</tr>';
            calender += '<tr>';
            var startpoint = choosestartpoint();
            for (var i = 1; (i - startpoint) <= days; i++) {
                if (i <= startpoint) {
                    calender += '<td></td>';
                } else {
                    if ((i - startpoint) == currentDate) {
                        calender += '<td bgcolor="blue" onclick="selectdayincalender(this)">' + (i - startpoint) + '</td>';
                    } else {
                        calender += '<td onclick="selectdayincalender(this)">' + (i - startpoint) + '</td>';
                    }
                    if (i == 7 || i == 14 || i == 21 || i == 28 || i == 35) {
                        calender += '</tr>';
                    }
                }
            }
            calender += '</table>';
            var timeoforderinput = document.getElementById("timeoforder");
            var showCalender = document.getElementById("dateoforder");
            showCalender.innerHTML = calender;
        }

        function placeOrder() {
            var timeoforder = document.getElementById("timeoforder");
            var error = document.getElementById('error');
            var xhr = new XMLHttpRequest();
            xhr.open("GET", `/order?=${timeoforder.value}`, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (this.readyState === XMLHttpRequest.DONE) {
                    if (this.status === 200) {
                        if (xhr.response) {
                            var serRes = JSON.parse(xhr.response);
                            if (serRes.error && serRes.error.length > 0 || serRes.rows == '') {
                                alert("There Was An Error While Placing Your Order")
                            } else {

                            }
                            orders.innerHTML = ordersvariableinfo;
                        }
                    } else {
                        alert("Order Not Sent, Please try Again")
                    }
                }
            }
            xhr.send();
        }

        function getMenuDetails() {
            var timeoforder = document.getElementById('timeoforder');
            var orders = document.getElementById('orders');
            var ordersvariableinfo = '';
            var error = document.getElementById('error');
            var xhr = new XMLHttpRequest();
            xhr.open("GET", `/getmenufordate?userdate=${timeoforder.value}`, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (this.readyState === XMLHttpRequest.DONE) {
                    if (this.status === 200) {
                        if (xhr.response) {
                            var serRes = JSON.parse(xhr.response);
                            menujson = serRes
                            if (serRes.error && serRes.error.length > 0 || serRes.rows == '') {
                                error.innerHTML = serRes.error
                                ordersvariableinfo = "<b>Sorry, There Is Nothing Being Served For The Date You Chose</b>"
                            } else {
                                for (var i = 0; i < serRes.rows.length; i++) {
                                    ordersvariableinfo += "<b><i>Dish: " + serRes.rows[i].Menu_Item + " Price: $" + serRes.rows[i].Price + " Quantity: "
                                        + "<div style='display:inline;'><select onchange='calculatelineitemtotal(event)' id='quantityfororder" + i + "'><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>"
                                        +" <div style='display:inline;'>Total Amount: <div id='totalamount" + i + "' style='display:inline;'></div></i></b><br><br></div>";
                                }
                                ordersvariableinfo += "Total Amount: $<input type='text' id='totalprice'><br><br>"
                                ordersvariableinfo += "<button value='Place Order' onclick='placeOrder()'>Place Order</button>"
                            }
                            orders.innerHTML = ordersvariableinfo;
                        }
                    } else {
                        alert("Order Not Sent, Please try Again")
                    }
                }
            }
            xhr.send();
        }

        function calculatelineitemtotal(event) {
            var targetId = event.target.id;
            var rowNumber = targetId.substring('quantityfororder'.length);
            var price = menujson.rows[rowNumber].Price
            var quantity = event.target;
            var selectedquantity = quantity.options[quantity.selectedIndex].text;
            var selectedrowprice = parseFloat(selectedquantity) * parseFloat(price);
            var totalamountdiv = document.getElementById("totalamount" + rowNumber +"")
            totalamountdiv.innerHTML = selectedrowprice.toFixed(2);
        }

        function selectdayincalender(datepar) {
            var selectdate = document.getElementById("timeoforder");
            var calender = document.getElementById("dateoforder");
            var date = new Date();
            var getDate = datepar.innerHTML;
            var getMonth = date.getMonth() + 1;
            var getYear = date.getFullYear();
            selectdate.value = getMonth + "/" + getDate + "/" + getYear;
            calender.innerHTML = '';
            getMenuDetails();
        }
        function previousmonth() {
            var date = new Date();
            var getMonth = date.getMonth - 1;
            var info = document.getElementById("info");
            info.innerHTML = "Reload the page MULTIPLE TIMES to go to the previous month";
        }
        function nextmonth() {
            var date = new Date();
            var getMonth = date.getMonth + 1;
            var info = document.getElementById("info");
            info.innerHTML = "Reload the page MULTIPLE TIMES to go to the next month";
        }
    </script>
    <title>Zayaka</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
    Date Of Order: <input id="timeoforder">
    <p id="dateoforder"></p>
    <button onclick="makeCalender()">Show Date Picker</button>
    <div id="orderdetails"></div>
    <p id="orders"></p>
    <p id="error"></p>
</body>

</html>